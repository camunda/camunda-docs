# Properties reference pages

This documentation contains properties reference pages.

They are based on `spring-configuration-metadata.json` [files](https://docs.spring.io/spring-boot/specification/configuration-metadata/format.html) that are processed and applied to a template.

The base directory for all properties reference pages is `/config-reference`.

In there, 2 things are done:

- docs are generated from the metadata
- the metadata itself is updated from the released artefact

## Docs generation

### What does this do?

The generation runs in several steps:

- it retrieves the component and the version for which a properties reference should be generated by reading the command that was used.
- it finds the mapped strategy
- it retrieves the metadata file, the output directory, the output file name and the component name from the strategy
- after that, it runs the actual generation:
  - a predefined function to clean the config reference (which deletes the old file)
  - a predefined function for docs pre-generation
  - a strategy-defined function for docs pre-generation
  - the actual generation step that writes the generated properties reference to the target file
  - a predefined function for docs post-generation
  - a strategy-defined function for docs post-generation
  - a formatting step

### How do I use it?

The command to generate the docs is registered in the `package.json` and can therefore be used as `npm run` script.

The command follows this pattern:

```shell
npm run config-reference:generate:${COMPONENT_NAME}
```

As soon as there are multiple versions supported, it will look like this:

```shell
npm run config-reference:generate:${COMPONENT_NAME}:${VERSION}
```

## Metadata update

As the metadata is packaged within a java archive, the easiest way to get the most recent version is by getting the most recent version of the artefact.

### What does this do?

The download follows the same steps as the generation, it just does not generate the docs, but use the context to update the metadata file:

- it retrieves the component and the version for which a properties reference should be generated by reading the command that was used.
- it finds the mapped strategy
- it retrieves the metadata file, the output directory, the output file name and the component name from the strategy
- after that, it runs the actual download:
  - a strategy-defined function to update the metadata file

### How do I use it?

The command to download the metadata file is registered in the `package.json` and can therefore be used as `npm run` script.

The command follows this pattern:

```shell
npm run config-reference:download:${COMPONENT_NAME}
```

As soon as there are multiple versions supported, it will look like this:

```shell
npm run config-reference:download:${COMPONENT_NAME}:${VERSION}
```

## How do I extend it?

To generate your own properties reference from here, you need to define a strategy and register it:

- create a new directory under `/config-reference` with the name of your component. Everything related to your component reference generation would live in there
- define a `generation-strategy.js`. It should have this structure:

```js
const baseDir = "./config-reference/..."; // path to your config reference base directory

function getOutputDir(version) {
  if (version === undefined) {
    return ""; // return the path to your version next output dir
  } else {
    return ""; // return the path to your versioned output dir
  }
}
const getMetadata = (version) => {
  if (version === undefined) {
    return myMetadata; // return metadata json for next version
  } else {
    return myVersionedMetadata; // return metadata json for versioned version
  }
};
const getFilename = (version) => {
  return "properties-reference.md"; // return the file name for your markdown
};
const preGenerateDocs = async (generationConfig) => {}; // apply some customizations upfront
const postGenerateDocs = async (generationConfig) => {}; // apply some customizations after the generation

const downloadReference = async (version) => {}; // ensure that the reference you return in `getMetadata(version)` is in place and up-to-date

const componentName = ""; // the human readable name of your component

const useHelm = false; // whether the generated documentation would refer to helm values as well. In that case, each property needs a field called "helm"

module.exports = {
  getOutputDir,
  getMetadata,
  getFilename,
  preGenerateDocs,
  postGenerateDocs,
  downloadReference,
  componentName,
  baseDir,
};
```

- register your strategy in `/config-reference/generate-config-reference.js` under `configRefStrategies` with the name you will be using the `npm run` script
- create your own `npm run` script in `/package.json` for generating your docs and downloading the most recent config reference
- let the generation run via `npm run` and review the log output and the generated properties reference
  - are all text properly formatted?
  - are property types replaced correctly? If not, you can take care of this in `preGenerateDocs()` of your strategy or extend the global `typeReplacements` map in `/config-reference/generate-config-reference.js`
